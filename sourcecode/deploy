#!/usr/bin/env ruby

# dependencies

require 'rubygems'
require 'commander/import'
require 'random-word' # used for vm name generation
require 'fileutils' # used for recursive folder creation
require 'dotenv' # reading .env files
# require 'sqlite3'
require 'bcrypt'
require 'active_record'

# load .env file
Dotenv.load

# Allowed distributions
$distributions = {
  'ubuntu' => 'ubuntu/xenial64',
  'debian' => 'debian/jessie64'
}

$webserver_root = [Dir.pwd, 'deepsky'].join('/')

ActiveRecord::Base.establish_connection(
  adapter:  ENV['DATABASE_ADAPTER'], # or 'postgresql' or 'sqlite3' or 'oracle_enhanced'
  database: [$webserver_root,'db','development.sqlite3'].join('/'),
)

class User < ActiveRecord::Base
end

class Machine < ActiveRecord::Base
end

program :name, 'deploy'
program :version, '0.0.1'
program :description, 'Create and destroy virtual machines'

command :new do |c|
  c.syntax = 'deploy new [options]'
  c.summary = 'Creates a new virtual machine'
  c.description = ''
  c.example 'description', 'command example'
  c.option '--username STRING',String, 'Specifies the authenticated user'
  c.option '--password STRING',String, 'Specifies the authenticated user\'s password'
  c.option '--distribution STRING',String, 'The distribution flavour (ubuntu, debian, etc.)'
  c.option '--vmname STRING',String, 'The name of the machine, generates a random name if left blank'
  c.action do |args, options|
    
    # VARS

    options.default :vmname => "#{RandomWord.adjs.next} #{RandomWord.adjs.next} #{RandomWord.nouns.next}"
    options.vmname = options.vmname.parametarize

    distribution = $distributions[options.distribution.to_s]
    vm_directory = ["userspace",options.username, options.vmname].join('/')
    # enforce required arguments

    {'username' => options.username, 'password' => options.password, 'distribution' => options.distribution}.each do |key, value|
      if value.to_s.empty?
        $stderr.puts "Missing argument: --#{key},\nuse --help for detailed instructions"
        exit 1
      end
    end
    
    # validate that the username exists

    db_user = User.where(email: options.username).take

    if (not db_user) or db_user.email != options.username
      $stderr.puts "Unable to find user '#{options.username}' in the system"
      exit 1
    end

    # validate password match

    bcrypt   = ::BCrypt::Password.new(db_user.encrypted_password)
    password = ::BCrypt::Engine.hash_secret(options.password, bcrypt.salt)

    if password != db_user.encrypted_password
      $stderr.puts "Username or password incorrect"
      exit 1
    end

    # validate that distribution is allowed
    
    if ! distribution
      $stderr.puts "Distribution '#{options.distribution.to_s}' is not a recognized option,\nOptions are: #{$distributions.keys}, aborting"
      exit 1
    end

    # validate vmname not taken
    machine = Machine.where(title: options.vmname).take
    if machine
      $stderr.puts "Name #{options.vmname} taken.We require unique names for each virtual machine, please use --vmname and specify name"
      exit 1
    end

    # validate folder not taken

    if File.directory?(vm_directory)
      $stderr.puts "Folder #{vm_directory} contains a virtual machine, aborting"
      exit 1      
    end

    vagrant_conf = <<HERE
    Vagrant.configure(2) do |config|
      config.vm.box = "#{distribution}"
      config.vm.provider "virtualbox" do |vb|
        vb.customize ["modifyvm", :id, "--cableconnected1", "on"]
         vb.name = "#{options.vmname}"
      end
    end
HERE

    if Dir.exists?(vm_directory)
      $stderr.puts "Directory #{vm_directory} exists, aborting"
      exit 1
    else
      FileUtils.mkdir_p(vm_directory)
    end
    
    # puts vagrant_conf

    # write conf file
    File.open("#{vm_directory}/Vagrantfile", 'w') { |file| 
      file.write(vagrant_conf)
    }

    # build machine
    exec(
      {
        "VAGRANT_DOTFILE_PATH" => "#{vm_directory}/",
        "VAGRANT_VAGRANTFILE" => "#{vm_directory}/Vagrantfile",
      },
      "/usr/bin/vagrant up"
    )

    $stdout.puts("Virtual machine '#{options.vmname}' created successfully for user '#{options.username}' using distribution '#{distribution}'")
    exit 0

  end
end